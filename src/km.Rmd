```{r km, cache=cacheon}

kmfunc <- function(time, event, eventcr = NULL, eventname, yposplus = rep(0, 2), ci = FALSE) {
  fits <- survfit(formula(paste0("Surv(", time, ",", event, "== 1) ~ num_dmRCT")),
    data = edata %>% filter(survpop)
  )

  if (!is.null(eventcr)) {
    fit <- cuminc(
      ftime = edata %>% filter(survpop) %>% pull(!!sym(time)),
      fstatus = edata %>% filter(survpop) %>% pull(!!sym(eventcr)),
      cencode = 0,
      group = edata %>% filter(survpop) %>% pull(num_dmRCT)
    )

    # c(bottom, left, top, right)
    par(mar = c(6, 4.5, 1, 4) + 0.1)

    plot(fit[1:2],
      ylab = eventname,
      col = global_kicols,
      wh = c(1110, 1110),
      xlim = c(0, 12 * 30),
      ylim = c(0, .3),
      xlab = "Months",
      axes = F,
      lwd = 3,
      lty = c(1, 2),
      xaxs = "i", yaxs = "i"
    )
  } else {
    # c(bottom, left, top, right)
    par(mar = c(6, 4.5, 1, 4) + 0.1)

    plot(fits,
      fun = "event",
      ylab = eventname,
      xscale = 30.5,
      yscale = 100,
      col = global_kicols,
      mark.time = FALSE,
      bty = "n",
      xlim = c(0, 12 * 30),
      ylim = c(0, .3),
      xlab = "Months",
      axes = F,
      lwd = 3,
      lty = c(1, 2),
      xaxs = "i", yaxs = "i"
    )
  }

  axis(2, seq(0, 0.5, 0.1), seq(0, 50, 10), las = 2)
  axis(1, at = seq(0, 12, 1) * 30, seq(0, 12, 1))

  if (!is.null(eventcr)) {
    ypos <- timepoints(fit[1:2], 12 * 30)$est
  } else {
    ypos <- 1 - summary(fits, 12 * 30)$surv
  }

  ylabs <- bind_cols(
    ypos = c(ypos + yposplus),
    ytext = c("Not TP", "TP")
  )

  mtext(
    side = 4,
    line = .2,
    at = ylabs$ypos,
    ylabs$ytext,
    las = 1
  )

  mtext("No. at risk", side = 1, line = 3, at = -60, adj = 0, cex = 1)

  mtext("Not TP", side = 1, line = 4, at = -55, adj = 0, cex = 1)
  mtext("TP", side = 1, line = 5, at = -55, adj = 0, cex = 1)

  nrisk <- summary(fits, seq(0, 12, 2) * 30)$n.risk

  axis(1, at = seq(0, 12, 2) * 30, labels = nrisk[1:7], line = 3, tick = FALSE, cex.axis = 1)
  axis(1, at = seq(0, 12, 2) * 30, labels = nrisk[8:14], line = 4, tick = FALSE, cex.axis = 1)

  # text(20, 0.65, paste0("P-value ", pm), pos = 4)
}
```

```{r kmdeath, fig.cap="1-KM All-cause mortality", cache=cacheon, dependson="km"}
kmfunc(
  time = "outtime_death",
  event = "out_death",
  eventname = "All-cause mortality (%)",
  yposplus = c(0, 0)
)
```

```{r km1hfhosp, fig.cap="First HF hospitalization", cache=cacheon, dependson="km"}
kmfunc(
  time = "outtime_hosphf",
  event = "out_hosphf",
  eventcr = "out_hosphf_cr",
  eventname = "First HF hospitalisation (%)",
  yposplus = c(0, 0)
)
```
