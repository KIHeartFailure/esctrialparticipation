---
title: 'Statistical report: Association between clinical trial participation and outcomes in patients with heart failure: observations from the ESC Heart Failure Long-Term Registry'
subtitle: 'DRAFT'
author: 'Statistician: Lina Benson'
  
date: "`r Sys.Date()`"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 7
    fig_width: 7
    number_sections: yes
link-citations: yes
bibliography: references.bib
nocite: '@*'
header-includes:
   - \usepackage{draftwatermark}
---

\newpage 
\tableofcontents 
\listoftables
\listoffigures
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, include = TRUE, comment = "",
  warning = FALSE, message = FALSE, fig.pos = "H",
  fig.path = "../output/figs/"
)
options(knitr.kable.NA = "")
```

```{r adjust_directory_if_needed, include=FALSE}
# Uncomment lines below if rmd file is placed in a subdirectory
knitr::opts_knit$set(root.dir = normalizePath("../"))
```

```{r load_project}
# 1. Set options in config/global.dcf
# 2. Load packages listed in config/global.dcf
# 3. Import functions and code in lib directory

ProjectTemplate::reload.project()

cacheon <- TRUE
```             

# Data handling

## Data source

hf3_lt_fu_data_soladis_jan19.sas7bdat (from the folder DATABASE_ANALYZED.ZIP). 

## Inclusion/exclusion criteria

```{r flow}
default_kable(flow, caption = "Flowchart")
```

First patient in: `r min(edata$num_dmVisitdt)` and last patient in: `r max(edata$num_dmVisitdt)`. 

The median age (IQR) is `r edata %>% summarise(med = fn(median(num_age, na.rm = TRUE), dig = 1),
                                             q1 = fn(quantile(num_age, na.rm = TRUE, probs = 0.25), dig = 1),
                                             q3 = fn(quantile(num_age, na.rm = TRUE, probs = 0.75), dig = 1)) %>%
                                   mutate(out = paste0(med, " (", q1, "-", q3, ")")) %>%
                                   pull(out)` and 
`r edata %>% count(num_dmgender) %>%
  mutate(perc = fn(n / sum(n) * 100, 1)) %>%
  filter(num_dmgender == "Female") %>%
  pull(perc)`% females.  

# Statistical analysis 

## General

All analyses were performed using `r sessionInfo()$R.version$version.string` [@r]. 
The level of significance is set to 5%, two-sided. No adjustment for multiple 
comparisons were made and therefore the results should be viewed with some care.

## Missing data

For patients with missing information on the date of hospitalisation, 
the time to hospitalisation was imputed with half the time to last
follow-up. Further, times to hospitalisation that were larger than time 
to death or last follow-up were set to death or last follow-up. 

Missing data for the covariates included in the models was imputed with multiple 
imputation using mice [@mice] for 10 datasets and 10 iterations. 
Variables included in the imputation model are the same as are 
included in the cox regression. Death was included as the Nelson-Aalen estimator 
in the imputation model. 

\clearpage 

## Baseline characteristics

```{r, child = "../src/tab1.Rmd"}

```

QUESTION: 

- For all patients there are multiple registrations 
of for example bp. In those cases, which values do you want to include?
- don't understand: you write: "MRA doses are depicted in spironolactone/eplerenone equivalents." Should ther be any conversion?
- For rasi (inc arni) it is not simple to convert arni/acei/arb to ONE contraindicates/not tolerated variable (the different variables will have different reasons). Could you take a look at what is presented now and see if that will suffice? 
- regarding the yes/not toleated/contraindicated variable. Just did for bbl at visit/discahrge for the moment, could you check and see if this is what you are after? I am a bit worried that it will be difficult to interpret. 

Note 

- for the follow-up medications if no medications at all are given there is not an option to give reason for not given. 
- for substances = "Other" no doses are shown (can't be converted)
- for patients taking more than one acei/arb/arni the max dose will be presented (not summeraized). 

## Assocation between trial participation and characteristics

Performed using logistic regression models.

QUESTION: 

- Which variables should be included? Any categorization ect?
- Do you want this as a table with uni and multi ORs ect or as a forest plot?

```{r, child = "../src/predictors.Rmd"}

```

## Outcome analysis

The following outcomes are considered: 

- All cause mortality
- CV mortality
- First HF hospitalisation
- All cause mortality/first HF hospitalisation

Time is from date of discharge, or if this is missing, date of admission and 
censored at death not defined as an event or follow-up.  

The outcomes are presented with the 1 - Kaplan-Meier curves. Cox proportional hazards regressions were 
used to model the time to first event analysis. 

The median (min-max) follow-up for the long-term outcomes is 
`r edata %>% filter(survpop) %>% summarise(med = fn(median(outtime_death / 365.25 * 12), dig = 1),
                                             min = fn(min(outtime_death / 365.25 * 12), dig = 1),
                                             max = fn(max(outtime_death / 365.25 * 12), dig = 1)) %>%
                                   mutate(out = paste0(med, " (", min, "-", max, ")")) %>%
                                   pull(out)` months for a total of 
                                   `r edata %>% filter(survpop) %>% 
                                   summarise(sumpy = fn(sum(outtime_death) / 365.25, dig = 0)) %>%
                                   pull(sumpy)` patient-years of follow-up.


```{r, child = "../src/km.Rmd"}

```

```{r, child = "../src/outtab.Rmd"}

```

QUESTION: 

- Which variabels should be included? 
- I can do Forest instead of table for outcomes when the variables are decided upon. 

### Assumptions

The proportional hazards assumption was investigated using the scaled Schoenfeld 
residuals (cox.zph in [@survival-package]) for the primary outcome. 
Possible outliers were visually inspected by plotting the dfbetas. 
=> XXXX. 

\clearpage
\newpage

# Reproducibility

## R session information {#sessioninfo}

```{r sessinfo}
sessionInfo()
```

## R code

The R code for all data handling and statistical analyses are found: 
https://github.com/KIHeartFailure/esctrialparticipation. On publication
the repository will be made public so as to 
link to it from the resulting article for increased transparency and code sharing.
No data or output is stored in the repository. 

# References
